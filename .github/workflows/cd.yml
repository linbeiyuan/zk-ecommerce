# CD 持续部署工作流
name: CD - 持续部署

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  # 构建并推送 Docker 镜像
  build-and-push:
    runs-on: ubuntu-latest
    name: 构建 Docker 镜像

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 登录 Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: 构建后端镜像
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/zk-backend:latest ./pyzkds
        docker push ${{ secrets.DOCKER_USERNAME }}/zk-backend:latest

    - name: 构建 Admin 前端镜像
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/zk-admin:latest ./admin/admin
        docker push ${{ secrets.DOCKER_USERNAME }}/zk-admin:latest

    - name: 构建 Front 前端镜像
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/zk-front:latest ./front/front
        docker push ${{ secrets.DOCKER_USERNAME }}/zk-front:latest

  # 部署到服务器
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    name: 部署到服务器

    steps:
    - name: 部署通知
      run: echo "镜像构建完成，可手动部署到服务器"
